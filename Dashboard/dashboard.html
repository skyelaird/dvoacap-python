<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VE1ATM HF Propagation</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e1a;
            color: #e0e0e0;
            line-height: 1.4;
            font-size: 13px;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%);
            padding: 0.75rem 1rem;
            border-bottom: 3px solid #4a90e2;
        }
        
        .header h1 {
            font-size: 1.3rem;
            color: #fff;
            margin-bottom: 0.3rem;
        }
        
        .station-info {
            display: flex;
            gap: 1.5rem;
            font-size: 0.75rem;
            color: #b0c4de;
        }
        
        .solar-bar {
            background: #162236;
            padding: 0.5rem 1rem;
            display: flex;
            gap: 2rem;
            justify-content: center;
            border-bottom: 1px solid #2a3f5f;
        }
        
        .solar-metric {
            text-align: center;
        }
        
        .solar-metric .label {
            font-size: 0.65rem;
            color: #8a9bb5;
            text-transform: uppercase;
        }
        
        .solar-metric .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4a90e2;
        }
        
        .solar-metric .sublabel {
            font-size: 0.6rem;
            color: #6a7f9f;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #2a3f5f;
        }
        
        .tab-button {
            background: #162236;
            border: none;
            color: #8a9bb5;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 6px 6px 0 0;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            border-bottom: none;
        }
        
        .tab-button:hover {
            background: #1a2738;
            color: #4a90e2;
        }
        
        .tab-button.active {
            background: #0a0e1a;
            color: #4a90e2;
            border-color: #2a3f5f;
            border-bottom-color: #0a0e1a;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .alert-bar {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            border: 2px solid #fca5a5;
            display: none;
        }
        
        .alert-bar.active {
            display: block;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        
        .grid-2col {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 1rem;
        }
        
        .card {
            background: #162236;
            border-radius: 6px;
            padding: 1rem;
            border: 1px solid #2a3f5f;
        }
        
        .card h2 {
            color: #4a90e2;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            border-bottom: 2px solid #2a3f5f;
            padding-bottom: 0.4rem;
        }
        
        #map {
            height: 450px;
            border-radius: 6px;
            border: 2px solid #2a3f5f;
        }
        
        .band-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.6rem;
        }
        
        .band-card {
            background: #0d1520;
            padding: 0.6rem;
            border-radius: 6px;
            text-align: center;
            border: 2px solid #2a3f5f;
        }
        
        .band-card:hover {
            border-color: #4a90e2;
        }
        
        .band-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 0.3rem;
        }
        
        .band-freq {
            font-size: 0.7rem;
            color: #6a7f9f;
            margin-bottom: 0.5rem;
        }
        
        .band-detail {
            font-size: 0.7rem;
            color: #8a9bb5;
            margin: 0.2rem 0;
        }
        
        .region-list {
            font-size: 0.75rem;
            text-align: left;
            margin-top: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .region-item {
            padding: 0.25rem 0;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #1a2738;
        }
        
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.4rem;
        }
        
        .status-good { background: #4ade80; }
        .status-fair { background: #fbbf24; }
        .status-poor { background: #f87171; }
        
        .quality-good { color: #4ade80; }
        .quality-fair { color: #fbbf24; }
        .quality-poor { color: #f87171; }
        
        .timeline {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .timeline-day {
            margin-bottom: 1rem;
        }
        
        .day-header {
            background: #0d1520;
            padding: 0.5rem;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }
        
        .timeline-hour {
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 0.75rem;
            padding: 0.4rem;
            border-bottom: 1px solid #1a2738;
            font-size: 0.8rem;
        }
        
        .timeline-hour:hover {
            background: #0d1520;
        }
        
        .timeline-hour.current {
            background: rgba(74, 144, 226, 0.2);
            border-left: 3px solid #4a90e2;
            font-weight: bold;
        }
        
        .hour-label {
            color: #4a90e2;
            font-weight: 600;
        }
        
        .hour-bands {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        
        .hour-band {
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        
        .hour-band.open {
            background: #065f46;
            color: #4ade80;
        }
        
        .hour-band.marginal {
            background: #713f12;
            color: #fbbf24;
        }
        
        .dxcc-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .dxcc-stat {
            background: #0d1520;
            padding: 0.75rem;
            border-radius: 6px;
            text-align: center;
        }
        
        .dxcc-stat .number {
            font-size: 2rem;
            font-weight: bold;
            color: #4a90e2;
        }
        
        .dxcc-stat .label {
            font-size: 0.75rem;
            color: #8a9bb5;
            margin-top: 0.3rem;
        }
        
        .most-wanted {
            font-size: 0.8rem;
        }
        
        .wanted-item {
            padding: 0.5rem;
            border-bottom: 1px solid #1a2738;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }
        
        .wanted-item.hot {
            background: rgba(74, 222, 128, 0.15);
            border-left: 3px solid #4ade80;
            animation: pulse 3s infinite;
        }
        
        .legend {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: #8a9bb5;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .update-info {
            text-align: center;
            color: #6a7f9f;
            font-size: 0.75rem;
            margin-top: 1rem;
            padding: 0.6rem;
            background: #162236;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #0d1520;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #2a3f5f;
            border-radius: 3px;
        }
        
        /* Refresh Button */
        .refresh-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #2d5a4f 0%, #3a8c6d 100%);
            color: white;
            border: 2px solid #4ade80;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(74, 222, 128, 0.3);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.5);
        }

        .refresh-btn:disabled {
            background: #2a3f5f;
            border-color: #4a5f7f;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Notification Modal */
        .notification-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #162236;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 2rem;
            min-width: 400px;
            max-width: 90vw;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
        }

        .notification-modal.show {
            display: block;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            display: none;
        }

        .modal-overlay.show {
            display: block;
        }

        .modal-header {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 1rem;
            text-align: center;
        }

        .modal-body {
            text-align: center;
            color: #e0e0e0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #0a0e1a;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90e2, #4ade80);
            width: 0%;
            transition: width 0.3s ease;
        }

        .modal-message {
            margin: 1rem 0;
            font-size: 0.9rem;
            color: #8a9bb5;
        }

        .modal-close-btn {
            background: #2a3f5f;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 1rem;
        }

        .modal-close-btn:hover {
            background: #3a5f8f;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(74, 144, 226, 0.3);
            border-top-color: #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1400px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }
            .band-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .notification-modal {
                min-width: 300px;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Refresh Button -->
    <button class="refresh-btn" id="refreshBtn" onclick="triggerRefresh()">
        ‚ö° Refresh Predictions
    </button>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay"></div>

    <!-- Notification Modal -->
    <div class="notification-modal" id="notificationModal">
        <div class="modal-header" id="modalHeader">Generating Predictions</div>
        <div class="modal-body">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="modal-message" id="modalMessage">
                <span class="spinner"></span>
                <span id="statusText">Initializing...</span>
            </div>
            <button class="modal-close-btn" id="closeBtn" style="display: none;" onclick="closeModal()">
                Close
            </button>
        </div>
    </div>

    <div class="header">
        <h1>üì° VE1ATM HF Propagation Monitor</h1>
        <div class="station-info">
            <span><strong>QTH:</strong> FN74ui (Lunenburg, NS)</span>
            <span><strong>Antenna:</strong> DX Commander 7m Vertical</span>
            <span><strong>Bands:</strong> 40m-10m</span>
        </div>
    </div>
    
    <div class="solar-bar" id="solarBar"></div>
    
    <div class="container">
        <div class="alert-bar" id="dxccAlerts">
            <strong>üéØ NEEDED DXCC - WORKABLE NOW:</strong>
            <div id="alertList" style="margin-top: 0.3rem;"></div>
        </div>
        
        <div class="tab-nav">
            <button class="tab-button active" onclick="showTab('overview')">üìä Overview</button>
            <button class="tab-button" onclick="showTab('bands')">üìª Band Details</button>
            <button class="tab-button" onclick="showTab('propcharts')">üìà Propagation Charts</button>
            <button class="tab-button" onclick="showTab('timeline')">‚è∞ 72-Hour Forecast</button>
            <button class="tab-button" onclick="showTab('dxcc')">üéØ DXCC Tracking</button>
            <button class="tab-button" onclick="showTab('config')">‚öôÔ∏è Station Config</button>
        </div>
        
        <!-- OVERVIEW TAB -->
        <div id="tab-overview" class="tab-content active">
            <div class="grid-2col">
                <div class="card">
                    <h2>üåç Current Band Openings <span id="grayLineTime" style="float: right; font-size: 0.75rem; font-weight: normal;"></span></h2>
                    <div id="map"></div>
                    <div class="legend">
                        <div class="legend-item"><span class="status-dot status-good"></span> Good (&gt;60%)</div>
                        <div class="legend-item"><span class="status-dot status-fair"></span> Fair (30-60%)</div>
                        <div class="legend-item"><span class="status-dot status-poor"></span> Poor (&lt;30%)</div>
                        <div class="legend-item">üåÖ Gray Line Zone</div>
                    </div>
                </div>

                <div class="card">
                    <h2>üìã Quick Summary</h2>
                    <div id="quickSummary"></div>
                </div>
            </div>

            <div class="grid-2col" style="margin-top: 1rem;">
                <div class="card">
                    <h2>‚è∞ 24-Hour Propagation Wheel</h2>
                    <div style="margin-bottom: 0.5rem; font-size: 0.8rem; color: #8a9bb5;">
                        <label>Select Region: </label>
                        <select id="wheelRegionSelect" onchange="renderPropWheel()" style="background: #162236; color: #e0e0e0; border: 1px solid #2a3f5f; padding: 0.3rem; border-radius: 4px; font-size: 0.8rem;">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div id="propWheel" style="height: 500px;"></div>
                    <div style="text-align: center; font-size: 0.75rem; color: #8a9bb5; margin-top: 0.5rem;">
                        Hover over bands to see reliability percentage. Outer ring = higher bands.
                    </div>
                </div>

                <div class="card">
                    <h2>üéØ Best Bands Right Now</h2>
                    <div id="bestBands"></div>
                </div>
            </div>
        </div>
        
        <!-- BANDS TAB -->
        <div id="tab-bands" class="tab-content">
            <div class="card">
                <h2>üìä Detailed Band Conditions (with S-Meter Estimates)</h2>
                <div class="band-grid" id="bandGrid"></div>
            </div>
        </div>

        <!-- PROPAGATION CHARTS TAB -->
        <div id="tab-propcharts" class="tab-content">
            <div class="card">
                <h2>üìà 24-Hour Propagation Analysis</h2>
                <div style="margin-bottom: 1rem;">
                    <label style="color: #4a90e2; font-weight: bold; margin-right: 0.5rem;">Select Band:</label>
                    <select id="chartBandSelect" onchange="renderPropChart()" style="background: #162236; color: #e0e0e0; border: 1px solid #2a3f5f; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                        <option value="40m">40m (7.150 MHz)</option>
                        <option value="30m">30m (10.125 MHz)</option>
                        <option value="20m" selected>20m (14.150 MHz)</option>
                        <option value="17m">17m (18.118 MHz)</option>
                        <option value="15m">15m (21.200 MHz)</option>
                        <option value="12m">12m (24.940 MHz)</option>
                        <option value="10m">10m (28.500 MHz)</option>
                    </select>

                    <label style="color: #4a90e2; font-weight: bold; margin-left: 1.5rem; margin-right: 0.5rem;">Select Region:</label>
                    <select id="chartRegionSelect" onchange="renderPropChart()" style="background: #162236; color: #e0e0e0; border: 1px solid #2a3f5f; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                        <!-- Options populated dynamically -->
                    </select>
                </div>

                <!-- Reliability Chart -->
                <div id="reliabilityChart" style="height: 300px; margin-bottom: 2rem;"></div>

                <!-- SNR Chart -->
                <div id="snrChart" style="height: 300px; margin-bottom: 2rem;"></div>

                <!-- Signal Power (SDBW) Chart -->
                <div id="sdbwChart" style="height: 300px; margin-bottom: 2rem;"></div>

                <!-- MUFday Chart -->
                <div id="mufdayChart" style="height: 300px;"></div>
            </div>
        </div>

        <!-- TIMELINE TAB -->
        <div id="tab-timeline" class="tab-content">
            <div class="card">
                <h2>‚è∞ 72-Hour Propagation Forecast</h2>
                <div class="timeline" id="timeline"></div>
            </div>
        </div>
        
        <!-- DXCC TAB -->
        <div id="tab-dxcc" class="tab-content">
            <div class="grid-2col">
                <div class="card">
                    <h2>üéØ DXCC Progress</h2>
                    <div class="dxcc-grid" id="dxccStats"></div>
                    <div class="most-wanted" id="mostWanted"></div>
                </div>
                
                <div class="card">
                    <h2>üìà DXCC Statistics</h2>
                    <div id="dxccDetails"></div>
                </div>
            </div>
        </div>

        <!-- STATION CONFIG TAB -->
        <div id="tab-config" class="tab-content">
            <div class="grid-2col">
                <!-- Station Information -->
                <div class="card">
                    <h2>üì° Station Information</h2>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">Operator Name</label>
                            <input type="text" id="stationName" placeholder="Your Name" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">Callsign</label>
                            <input type="text" id="stationCallsign" placeholder="VE1ATM" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">Grid Square</label>
                            <input type="text" id="stationGrid" placeholder="FN74ui" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">Latitude</label>
                                <input type="number" id="stationLat" placeholder="44.374" step="0.001" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">Longitude</label>
                                <input type="number" id="stationLon" placeholder="-64.300" step="0.001" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">Power (Watts)</label>
                            <input type="number" id="stationPower" placeholder="100" min="1" max="1500" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                        </div>
                        <button onclick="saveStationConfig()" style="background: #4a90e2; color: white; border: none; padding: 0.7rem; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 0.5rem;">üíæ Save Station Info</button>
                    </div>
                </div>

                <!-- Antenna Configuration -->
                <div class="card">
                    <h2>üìª Antenna Configuration</h2>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <button onclick="addAntenna()" style="background: #2d5a8c; color: white; border: none; padding: 0.7rem; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%;">‚ûï Add Antenna</button>
                        </div>
                        <div id="antennaList" style="display: flex; flex-direction: column; gap: 0.8rem;">
                            <!-- Antennas will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Band-to-Antenna Assignment -->
            <div class="card" style="margin-top: 1rem;">
                <h2>üîó Band-to-Antenna Assignment</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">160m</label>
                        <select id="band-160m" class="band-antenna-select" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                            <option value="">Not Configured</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">80m</label>
                        <select id="band-80m" class="band-antenna-select" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                            <option value="">Not Configured</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">40m</label>
                        <select id="band-40m" class="band-antenna-select" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                            <option value="">Not Configured</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">30m</label>
                        <select id="band-30m" class="band-antenna-select" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                            <option value="">Not Configured</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">20m</label>
                        <select id="band-20m" class="band-antenna-select" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                            <option value="">Not Configured</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">17m</label>
                        <select id="band-17m" class="band-antenna-select" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                            <option value="">Not Configured</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">15m</label>
                        <select id="band-15m" class="band-antenna-select" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                            <option value="">Not Configured</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">12m</label>
                        <select id="band-12m" class="band-antenna-select" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                            <option value="">Not Configured</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 0.3rem; color: #4a90e2;">10m</label>
                        <select id="band-10m" class="band-antenna-select" style="width: 100%; padding: 0.5rem; background: #1a2332; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                            <option value="">Not Configured</option>
                        </select>
                    </div>
                </div>
                <button onclick="saveBandAssignments()" style="background: #4a90e2; color: white; border: none; padding: 0.7rem; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 1rem;">üíæ Save Band Assignments</button>
            </div>

            <!-- EME Calculator (Placeholder for future) -->
            <div class="card" style="margin-top: 1rem;">
                <h2>üåô EME (Earth-Moon-Earth) Calculator</h2>
                <div style="padding: 2rem; text-align: center; color: #8a9bb5;">
                    <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">Coming Soon</p>
                    <p style="font-size: 0.9rem;">EME propagation calculator will be available in a future update.</p>
                    <p style="font-size: 0.8rem; margin-top: 1rem; color: #6a7f9f;">Track moonrise/moonset, path loss, Doppler shift, and optimal EME windows.</p>
                </div>
            </div>
        </div>

        <div class="update-info" id="updateInfo"></div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let propData = null;
        let map = null;
        let grayLineLayer = null;
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function snrToSMeter(snr) {
            if (snr >= 45) return 'S9+40';
            if (snr >= 35) return 'S9+30';
            if (snr >= 25) return 'S9+20';
            if (snr >= 15) return 'S9+10';
            if (snr >= 10) return 'S9';
            if (snr >= 4) return 'S8';
            if (snr >= -2) return 'S7';
            if (snr >= -8) return 'S6';
            if (snr >= -14) return 'S5';
            if (snr >= -20) return 'S4';
            if (snr >= -26) return 'S3';
            return 'S2';
        }
        
        async function loadPropagationData() {
            try {
                const response = await fetch('enhanced_predictions.json');
                const data = await response.json();
                // Extract the predictions object from the data structure
                propData = data.predictions || data;
                initializeDashboard();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('updateInfo').innerHTML =
                    '<strong>‚ö†Ô∏è Error loading data. Please regenerate predictions.</strong>';
            }
        }
        
        function initializeDashboard() {
            renderSolarBar();
            renderMap();
            renderQuickSummary();
            renderBandGrid();
            renderTimeline();
            renderDXCC();
            renderUpdateInfo();
            checkDXCCAlerts();
            initPropCharts();
            initPropWheel();
            renderBestBands();

            // Update gray line every 5 minutes
            setInterval(updateGrayLine, 300000);
        }

        function initPropWheel() {
            if (!propData.propagation_charts) {
                console.warn('No propagation charts data for wheel');
                return;
            }

            // Get available regions from first band
            const firstBand = Object.keys(propData.propagation_charts)[0];
            const regions = Object.keys(propData.propagation_charts[firstBand].regions).sort();

            const regionSelect = document.getElementById('wheelRegionSelect');
            regionSelect.innerHTML = '';

            regions.forEach(regionCode => {
                const regionName = propData.propagation_charts[firstBand].regions[regionCode].name;
                const option = document.createElement('option');
                option.value = regionCode;
                option.textContent = `${regionCode} - ${regionName}`;
                regionSelect.appendChild(option);
            });

            if (regions.length > 0) {
                regionSelect.value = regions[0];
                renderPropWheel();
            }
        }

        function renderPropWheel() {
            const region = document.getElementById('wheelRegionSelect').value;
            if (!propData.propagation_charts) return;

            // Bands to display (from low to high frequency)
            const bands = ['40m', '30m', '20m', '17m', '15m', '12m', '10m'];
            const bandColors = {
                '40m': '#8b5cf6',
                '30m': '#6366f1',
                '20m': '#3b82f6',
                '17m': '#06b6d4',
                '15m': '#10b981',
                '12m': '#fbbf24',
                '10m': '#f87171'
            };

            const traces = [];

            // Create a polar trace for each band
            bands.forEach((band, idx) => {
                const chartData = propData.propagation_charts[band];
                if (!chartData || !chartData.regions[region]) return;

                const regionData = chartData.regions[region];
                const hours = chartData.hours;

                // Convert hours to angles (0 = top/north, clockwise)
                const theta = hours.map(h => h * 15);  // 15 degrees per hour
                const r = regionData.reliability;

                traces.push({
                    type: 'scatterpolar',
                    r: r,
                    theta: theta,
                    mode: 'lines',
                    name: band,
                    line: {
                        color: bandColors[band],
                        width: 3
                    },
                    fill: 'toself',
                    fillcolor: bandColors[band] + '40'  // Add transparency
                });
            });

            const regionName = propData.propagation_charts['20m'].regions[region].name;

            const layout = {
                polar: {
                    bgcolor: '#0a0e1a',
                    radialaxis: {
                        visible: true,
                        range: [0, 100],
                        gridcolor: '#2a3f5f',
                        tickfont: { color: '#8a9bb5', size: 10 }
                    },
                    angularaxis: {
                        tickmode: 'array',
                        tickvals: [0, 30, 60, 90, 120, 150, 180, 210, 240, 270, 300, 330],
                        ticktext: ['00', '02', '04', '06', '08', '10', '12', '14', '16', '18', '20', '22'],
                        direction: 'clockwise',
                        gridcolor: '#2a3f5f',
                        tickfont: { color: '#e0e0e0', size: 11 }
                    }
                },
                paper_bgcolor: '#162236',
                font: { color: '#e0e0e0' },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.15,
                    x: 0.5,
                    xanchor: 'center',
                    font: { size: 11 }
                },
                title: {
                    text: `Propagation to ${regionName}`,
                    font: { color: '#4a90e2', size: 14 },
                    y: 0.95
                },
                margin: { t: 60, r: 40, b: 60, l: 40 }
            };

            Plotly.newPlot('propWheel', traces, layout, {responsive: true, displayModeBar: false});
        }

        function renderBestBands() {
            if (!propData.propagation_charts) {
                document.getElementById('bestBands').innerHTML = '<p style="color: #8a9bb5; padding: 1rem;">No propagation data available</p>';
                return;
            }

            const currentHour = new Date().getUTCHours();
            const bands = ['40m', '30m', '20m', '17m', '15m', '12m', '10m'];

            // Calculate scores for each band across all regions
            const bandScores = [];

            bands.forEach(band => {
                const chartData = propData.propagation_charts[band];
                if (!chartData) return;

                let totalScore = 0;
                let regionCount = 0;

                // Find data for current hour
                const hourIdx = chartData.hours.indexOf(currentHour);
                if (hourIdx === -1) return;

                Object.keys(chartData.regions).forEach(regionCode => {
                    const regionData = chartData.regions[regionCode];
                    const reliability = regionData.reliability[hourIdx] || 0;
                    const snr = regionData.snr[hourIdx] || -999;
                    const mufDay = regionData.muf_day[hourIdx] || 0;

                    // Scoring algorithm: (Reliability √ó 0.5) + (SNR_normalized √ó 0.3) + ((100-MUFday) √ó 0.2)
                    const snrNormalized = Math.max(0, Math.min(100, (snr + 20) * 2));  // Normalize SNR to 0-100
                    const mufScore = 100 - mufDay;  // Lower MUFday is better
                    const score = (reliability * 0.5) + (snrNormalized * 0.3) + (mufScore * 0.2);

                    totalScore += score;
                    regionCount++;
                });

                if (regionCount > 0) {
                    bandScores.push({
                        band: band,
                        avgScore: totalScore / regionCount,
                        regions: regionCount
                    });
                }
            });

            // Sort by score descending
            bandScores.sort((a, b) => b.avgScore - a.avgScore);

            // Display top 5 bands
            let html = '<div style="font-size: 0.9rem;">';

            if (bandScores.length === 0) {
                html += '<p style="color: #8a9bb5; padding: 1rem; text-align: center;">No band openings currently</p>';
            } else {
                bandScores.slice(0, 5).forEach((bandScore, idx) => {
                    const score = bandScore.avgScore;
                    let quality = 'Poor';
                    let color = '#f87171';

                    if (score >= 70) {
                        quality = 'Excellent';
                        color = '#4ade80';
                    } else if (score >= 50) {
                        quality = 'Good';
                        color = '#fbbf24';
                    } else if (score >= 30) {
                        quality = 'Fair';
                        color = '#fb923c';
                    }

                    const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : 'üèÖ';

                    html += `
                        <div style="padding: 0.7rem; margin-bottom: 0.5rem; background: #0d1520; border-radius: 6px; border-left: 4px solid ${color};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.2rem;">${medal}</span>
                                    <span style="font-weight: bold; font-size: 1.1rem; color: ${color};">${bandScore.band}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: ${color};">${quality}</div>
                                    <div style="font-size: 0.75rem; color: #8a9bb5;">Score: ${score.toFixed(0)}/100</div>
                                </div>
                            </div>
                            <div style="margin-top: 0.3rem; font-size: 0.75rem; color: #8a9bb5;">
                                ${bandScore.regions} regions accessible
                            </div>
                        </div>
                    `;
                });

                html += `<div style="margin-top: 1rem; padding: 0.7rem; background: #1a2738; border-radius: 6px; font-size: 0.75rem; color: #8a9bb5; text-align: center;">
                    <strong>Scoring:</strong> Reliability (50%) + SNR (30%) + MUF Safety (20%)
                </div>`;
            }

            html += '</div>';
            document.getElementById('bestBands').innerHTML = html;
        }

        function initPropCharts() {
            // Populate region selector with available regions
            if (!propData.propagation_charts) {
                console.warn('No propagation charts data available');
                return;
            }

            const band = '20m';  // Default band
            const chartData = propData.propagation_charts[band];

            if (!chartData || !chartData.regions) {
                console.warn('No chart data for band:', band);
                return;
            }

            const regionSelect = document.getElementById('chartRegionSelect');
            regionSelect.innerHTML = '';

            // Add regions as options
            const regions = Object.keys(chartData.regions).sort();
            regions.forEach(regionCode => {
                const regionName = chartData.regions[regionCode].name;
                const option = document.createElement('option');
                option.value = regionCode;
                option.textContent = `${regionCode} - ${regionName}`;
                regionSelect.appendChild(option);
            });

            // Select first region by default (typically EU or UK)
            if (regions.length > 0) {
                regionSelect.value = regions[0];
            }

            // Render initial charts
            renderPropChart();
        }

        function renderPropChart() {
            const band = document.getElementById('chartBandSelect').value;
            const region = document.getElementById('chartRegionSelect').value;

            if (!propData.propagation_charts || !propData.propagation_charts[band]) {
                console.error('No chart data for band:', band);
                return;
            }

            const chartData = propData.propagation_charts[band];
            const regionData = chartData.regions[region];

            if (!regionData) {
                console.error('No data for region:', region);
                return;
            }

            const hours = chartData.hours;
            const regionName = regionData.name;

            // Common layout settings
            const commonLayout = {
                paper_bgcolor: '#162236',
                plot_bgcolor: '#0a0e1a',
                font: { color: '#e0e0e0', size: 12 },
                margin: { t: 40, r: 40, b: 40, l: 60 },
                xaxis: {
                    title: 'Hour (UTC)',
                    gridcolor: '#2a3f5f',
                    zeroline: false
                },
                yaxis: {
                    gridcolor: '#2a3f5f',
                    zeroline: false
                },
                hovermode: 'x unified'
            };

            // 1. Reliability Chart
            const relTrace = {
                x: hours,
                y: regionData.reliability,
                mode: 'lines+markers',
                name: 'Reliability (%)',
                line: { color: '#4a90e2', width: 3 },
                marker: { size: 6, color: '#4a90e2' }
            };

            Plotly.newPlot('reliabilityChart', [relTrace], {
                ...commonLayout,
                title: { text: `Reliability - ${band} to ${regionName}`, font: { color: '#4a90e2', size: 16 } },
                yaxis: { ...commonLayout.yaxis, title: 'Reliability (%)', range: [0, 100] }
            }, {responsive: true, displayModeBar: false});

            // 2. SNR Chart
            const snrTrace = {
                x: hours,
                y: regionData.snr,
                mode: 'lines+markers',
                name: 'SNR (dB)',
                line: { color: '#fbbf24', width: 3 },
                marker: { size: 6, color: '#fbbf24' }
            };

            Plotly.newPlot('snrChart', [snrTrace], {
                ...commonLayout,
                title: { text: `Signal-to-Noise Ratio - ${band} to ${regionName}`, font: { color: '#fbbf24', size: 16 } },
                yaxis: { ...commonLayout.yaxis, title: 'SNR (dB)' }
            }, {responsive: true, displayModeBar: false});

            // 3. Signal Power (SDBW) Chart with distribution
            const sdbwTrace = {
                x: hours,
                y: regionData.signal_dbw,
                mode: 'lines+markers',
                name: 'Median Power (dBW)',
                line: { color: '#4ade80', width: 3 },
                marker: { size: 6, color: '#4ade80' }
            };

            const sdbw10Trace = {
                x: hours,
                y: regionData.signal_10,
                mode: 'lines',
                name: '10th Percentile (Weak)',
                line: { color: '#6ee7b7', width: 1, dash: 'dot' },
                fill: 'none'
            };

            const sdbw90Trace = {
                x: hours,
                y: regionData.signal_90,
                mode: 'lines',
                name: '90th Percentile (Strong)',
                line: { color: '#10b981', width: 1, dash: 'dot' },
                fill: 'tonexty',
                fillcolor: 'rgba(74, 222, 128, 0.2)'
            };

            Plotly.newPlot('sdbwChart', [sdbw10Trace, sdbw90Trace, sdbwTrace], {
                ...commonLayout,
                title: { text: `Signal Power - ${band} to ${regionName}`, font: { color: '#4ade80', size: 16 } },
                yaxis: { ...commonLayout.yaxis, title: 'Power (dBW)' }
            }, {responsive: true, displayModeBar: false});

            // 4. MUFday Chart
            const mufdayTrace = {
                x: hours,
                y: regionData.muf_day,
                mode: 'lines+markers',
                name: 'MUFday (%)',
                line: { color: '#f87171', width: 3 },
                marker: { size: 6, color: '#f87171' },
                fill: 'tozeroy',
                fillcolor: 'rgba(248, 113, 113, 0.2)'
            };

            // Add warning line at 90%
            const warningLine = {
                x: hours,
                y: Array(hours.length).fill(90),
                mode: 'lines',
                name: 'Warning Threshold',
                line: { color: '#fbbf24', width: 2, dash: 'dash' }
            };

            Plotly.newPlot('mufdayChart', [mufdayTrace, warningLine], {
                ...commonLayout,
                title: { text: `MUF Usage - ${band} to ${regionName}`, font: { color: '#f87171', size: 16 } },
                yaxis: { ...commonLayout.yaxis, title: 'MUFday (%)', range: [0, 100] },
                annotations: [{
                    x: hours[Math.floor(hours.length / 2)],
                    y: 90,
                    xref: 'x',
                    yref: 'y',
                    text: 'Warning: >90% may be unreliable',
                    showarrow: false,
                    yshift: 15,
                    font: { color: '#fbbf24', size: 10 }
                }]
            }, {responsive: true, displayModeBar: false});
        }
        
        function renderSolarBar() {
            const solar = propData.current_conditions.solar;
            let condition = 'Good';
            if (solar.kp > 4) condition = 'Poor';
            else if (solar.kp > 3) condition = 'Fair';
            
            document.getElementById('solarBar').innerHTML = `
                <div class="solar-metric">
                    <div class="label">SFI</div>
                    <div class="value">${solar.sfi}</div>
                    <div class="sublabel">${solar.sfi > 150 ? 'High' : 'Mod'}</div>
                </div>
                <div class="solar-metric">
                    <div class="label">SSN</div>
                    <div class="value">${solar.ssn}</div>
                    <div class="sublabel">${solar.ssn > 100 ? 'Active' : 'Quiet'}</div>
                </div>
                <div class="solar-metric">
                    <div class="label">Kp</div>
                    <div class="value">${solar.kp}</div>
                    <div class="sublabel">${solar.kp < 3 ? 'Quiet' : 'Unsettled'}</div>
                </div>
                <div class="solar-metric">
                    <div class="label">A</div>
                    <div class="value">${solar.a_index}</div>
                    <div class="sublabel">${solar.a_index < 20 ? 'Excellent' : 'Good'}</div>
                </div>
                <div class="solar-metric">
                    <div class="label">Conditions</div>
                    <div class="value" style="font-size: 1rem;">${condition}</div>
                    <div class="sublabel">HF Prop</div>
                </div>
            `;
        }
        
        function renderQuickSummary() {
            const bands = propData.current_conditions.bands;
            let summary = '<div style="font-size: 0.85rem;">';
            
            // Best bands
            summary += '<div style="margin-bottom: 1rem;"><strong style="color: #4a90e2;">Best Bands Right Now:</strong><br>';
            for (const [bandName, bandData] of Object.entries(bands)) {
                let goodCount = 0;
                for (const [code, region] of Object.entries(bandData.regions)) {
                    if (region.reliability > 60) goodCount++;
                }
                if (goodCount > 0) {
                    summary += `<div style="padding: 0.3rem 0;">‚Ä¢ ${bandName}: ${goodCount} regions open</div>`;
                }
            }
            summary += '</div>';
            
            // DXCC quick stats
            const dxcc = propData.dxcc;
            summary += `<div><strong style="color: #4a90e2;">DXCC Progress:</strong><br>
                <div style="padding: 0.3rem 0;">‚Ä¢ Worked: ${dxcc.dxcc_worked?.length || 0}</div>
                <div style="padding: 0.3rem 0;">‚Ä¢ Confirmed: ${dxcc.dxcc_confirmed_lotw?.length || 0}</div>
                <div style="padding: 0.3rem 0;">‚Ä¢ Needed: ${dxcc.dxcc_missing?.length || 0}</div>
            </div>`;
            
            summary += '</div>';
            document.getElementById('quickSummary').innerHTML = summary;
        }
        
        function renderBandGrid() {
            const bands = propData.current_conditions.bands;
            let html = '';
            
            for (const [bandName, bandData] of Object.entries(bands)) {
                let maxMuf = 0;
                let goodRegions = [];
                let fairRegions = [];
                
                for (const [code, data] of Object.entries(bandData.regions)) {
                    if (data.muf > maxMuf) maxMuf = data.muf;
                    if (data.quality === 'GOOD') goodRegions.push({code, ...data});
                    else if (data.quality === 'FAIR') fairRegions.push({code, ...data});
                }
                
                const optimalFreq = (maxMuf * 0.85).toFixed(2);
                const peakTime = bandName === '40m' ? 'Evening' : 
                               (bandName === '30m' || bandName === '20m') ? 'Day/Night' : 'Daytime';
                
                let regionHtml = '';
                [...goodRegions.slice(0, 4), ...fairRegions.slice(0, 3)].forEach(r => {
                    const quality = r.quality === 'GOOD' ? 'good' : 'fair';
                    regionHtml += `<div class="region-item">
                        <span><span class="status-dot status-${quality}"></span>${r.code}</span>
                        <span class="quality-${quality}">${snrToSMeter(r.snr_db)}</span>
                    </div>`;
                });
                
                if (!regionHtml) regionHtml = '<div style="text-align: center; color: #6b7280; padding: 0.5rem; font-size: 0.75rem;">Closed</div>';
                
                html += `
                    <div class="band-card">
                        <div class="band-name">${bandName}</div>
                        <div class="band-freq">${bandData.frequency} MHz</div>
                        <div class="band-detail">MUF: ${maxMuf.toFixed(1)}</div>
                        <div class="band-detail">Best: ${optimalFreq}</div>
                        <div class="band-detail" style="color: #fbbf24;">${peakTime}</div>
                        <div class="region-list">${regionHtml}</div>
                    </div>
                `;
            }
            
            document.getElementById('bandGrid').innerHTML = html;
        }
        
        function renderTimeline() {
            const timeline = propData.timeline_24h;
            const currentHour = new Date().getUTCHours();
            let html = '';
            let currentDay = '';
            
            for (let i = 0; i < timeline.hours.length; i++) {
                if (i < 24) {
                    if (i % 2 !== 0) continue;
                } else {
                    if (i % 6 !== 0) continue;
                }
                
                const hour = timeline.hours[i];
                const time = new Date(hour.time);
                const dayStr = time.toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'});
                
                if (dayStr !== currentDay) {
                    if (currentDay !== '') html += '</div>';
                    html += `<div class="timeline-day"><div class="day-header">${dayStr}</div>`;
                    currentDay = dayStr;
                }
                
                const isCurrent = hour.hour_utc === currentHour && i < 24;
                const hourLabel = time.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: false});
                
                let bandHtml = '';
                for (const [bandName, status] of Object.entries(hour.bands)) {
                    if (status.open.length > 0) {
                        bandHtml += `<div class="hour-band open">${bandName}: ${status.open.join(',')}</div>`;
                    } else if (status.marginal.length > 0 && i < 24) {
                        bandHtml += `<div class="hour-band marginal">${bandName}: ${status.marginal.join(',')}</div>`;
                    }
                }
                
                if (!bandHtml) bandHtml = '<span style="color: #6b7280;">No openings</span>';
                
                html += `
                    <div class="timeline-hour ${isCurrent ? 'current' : ''}">
                        <div class="hour-label">${isCurrent ? '‚ñ∂ ' : ''}${hourLabel}Z</div>
                        <div class="hour-bands">${bandHtml}</div>
                    </div>
                `;
            }
            
            html += '</div>';
            document.getElementById('timeline').innerHTML = html;
        }
        
        function renderDXCC() {
            const dxcc = propData.dxcc;
            const worked = dxcc.dxcc_worked?.length || 0;
            const confirmed = dxcc.dxcc_confirmed_lotw?.length || 0;
            const missing = dxcc.dxcc_missing?.length || 0;
            
            document.getElementById('dxccStats').innerHTML = `
                <div class="dxcc-stat">
                    <div class="number">${worked}</div>
                    <div class="label">Worked</div>
                </div>
                <div class="dxcc-stat">
                    <div class="number">${confirmed}</div>
                    <div class="label">Confirmed</div>
                </div>
                <div class="dxcc-stat">
                    <div class="number">${missing}</div>
                    <div class="label">Needed</div>
                </div>
            `;
            
            // Most wanted list with actual propagation data
            if (dxcc.entity_names && dxcc.dxcc_missing) {
                const bands = propData.current_conditions.bands;
                
                // Map common entities to regions (simplified mapping)
                const entityToRegion = {
                    // Africa
                    'Abu Ail': 'AF', 'Agalega & St Brandon Is.': 'AF', 'Aldabra': 'AF',
                    'Eritrea': 'AF', 'Chad': 'AF', 'Guinea-Bissau': 'AF',
                    // Asia
                    'Afghanistan': 'AS', 'Andaman & Nicobar Is.': 'AS', 'Nepal': 'AS',
                    'Asiatic Russia': 'AS', 'Bhutan': 'AS', 'North Korea': 'AS',
                    // Europe
                    'Aland Islands': 'EU', 'Albania': 'EU', 'Andorra': 'EU',
                    'Market Reef': 'EU', 'Jan Mayen': 'EU', 'Svalbard': 'EU',
                    // Oceania
                    'American Samoa': 'OC', 'Baker & Howland Islands': 'OC',
                    'Chesterfield Is.': 'OC', 'Conway Reef': 'OC',
                    // South America
                    'Galapagos Islands': 'SA', 'Fernando de Noronha': 'SA',
                    'Trindade & Martim Vaz Islands': 'SA',
                    // Antarctica
                    'Antarctica': 'OC', 'Peter 1 Island': 'OC', 'South Sandwich Islands': 'OC',
                    // Middle East
                    'Jordan': 'AS', 'Palestine': 'AS', 'Syria': 'AS', 'Yemen': 'AS'
                };
                
                // Build list with propagation status
                const neededList = [];
                const topNeeded = dxcc.dxcc_missing.slice(0, 30);
                
                topNeeded.forEach(id => {
                    const entityName = dxcc.entity_names[id];
                    if (!entityName) return;
                    
                    // Find which region this entity is in
                    const region = entityToRegion[entityName] || null;
                    const openBands = [];
                    
                    if (region) {
                        // Check which bands have good propagation to this region
                        for (const [bandName, bandData] of Object.entries(bands)) {
                            const regionData = bandData.regions[region];
                            if (regionData && regionData.reliability > 60) {
                                openBands.push({
                                    band: bandName,
                                    reliability: regionData.reliability,
                                    smeter: snrToSMeter(regionData.snr_db)
                                });
                            }
                        }
                    }
                    
                    neededList.push({
                        name: entityName,
                        region: region,
                        openBands: openBands,
                        isOpen: openBands.length > 0
                    });
                });
                
                // Sort: open first, then by name
                neededList.sort((a, b) => {
                    if (a.isOpen && !b.isOpen) return -1;
                    if (!a.isOpen && b.isOpen) return 1;
                    return a.name.localeCompare(b.name);
                });
                
                // Render list (limit to 15 to avoid scrollbar)
                let html = '<div style="margin-bottom: 0.5rem; font-weight: bold; color: #4a90e2;">Top 15 Most Wanted:</div>';
                
                neededList.slice(0, 15).forEach(entity => {
                    let statusHtml = '';
                    if (entity.isOpen) {
                        const bandList = entity.openBands.map(b => 
                            `${b.band} (${b.smeter})`
                        ).join(', ');
                        statusHtml = `<span style="color: #4ade80; font-weight: bold;">‚ö° ${bandList}</span>`;
                    } else if (entity.region) {
                        statusHtml = `<span style="color: #6b7280;">‚Üí ${entity.region} closed</span>`;
                    } else {
                        statusHtml = `<span style="color: #6b7280;">--</span>`;
                    }
                    
                    html += `<div class="wanted-item ${entity.isOpen ? 'hot' : ''}">
                        <span style="flex: 1;">${entity.name}</span>
                        <span style="font-size: 0.75rem;">${statusHtml}</span>
                    </div>`;
                });
                
                document.getElementById('mostWanted').innerHTML = html;
            }
            
            // DXCC details
            const confRate = worked > 0 ? Math.round((confirmed / worked) * 100) : 0;
            document.getElementById('dxccDetails').innerHTML = `
                <div style="font-size: 0.85rem;">
                    <div style="margin-bottom: 1rem;">
                        <strong>Confirmation Rate:</strong> ${confRate}%<br>
                        <div style="background: #0d1520; height: 20px; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                            <div style="background: #4ade80; height: 100%; width: ${confRate}%;"></div>
                        </div>
                    </div>
                    <div style="padding: 0.5rem 0; border-top: 1px solid #2a3f5f;">
                        <strong>To DXCC Honor Roll:</strong><br>
                        Need ${Math.max(0, 331 - confirmed)} more confirmed
                    </div>
                    <div style="padding: 0.5rem 0; border-top: 1px solid #2a3f5f;">
                        <strong>Progress:</strong><br>
                        ${Math.round((worked / 340) * 100)}% of current DXCC list
                    </div>
                </div>
            `;
        }
        
        function checkDXCCAlerts() {
            const bands = propData.current_conditions.bands;
            const dxcc = propData.dxcc;
            
            // Find regions with excellent propagation (>70%)
            let excellentRegions = [];
            for (const [bandName, bandData] of Object.entries(bands)) {
                for (const [code, region] of Object.entries(bandData.regions)) {
                    if (region.reliability > 70) {
                        excellentRegions.push({
                            band: bandName,
                            region: code,
                            name: region.name,
                            reliability: region.reliability
                        });
                    }
                }
            }
            
            if (excellentRegions.length > 0) {
                const alertBar = document.getElementById('dxccAlerts');
                alertBar.classList.add('active');
                
                // Group by region
                const regionSummary = {};
                excellentRegions.forEach(r => {
                    if (!regionSummary[r.region]) {
                        regionSummary[r.region] = {
                            name: r.name,
                            bands: []
                        };
                    }
                    regionSummary[r.region].bands.push(r.band);
                });
                
                let alertText = 'Excellent propagation now: ';
                const alerts = [];
                for (const [code, data] of Object.entries(regionSummary)) {
                    alerts.push(`<strong>${code}</strong> (${data.bands.join(', ')})`);
                }
                
                document.getElementById('alertList').innerHTML = 
                    alertText + alerts.join(' ‚Ä¢ ') + ' - Check Most Wanted list below!';
            }
        }
        
        function drawGrayLine() {
            if (!map) return;
            
            // Remove old gray line
            if (grayLineLayer) {
                map.removeLayer(grayLineLayer);
            }
            
            const now = new Date();
            const hours = now.getUTCHours() + now.getUTCMinutes() / 60;
            const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 86400000);
            const declination = 23.45 * Math.sin((360/365) * (dayOfYear - 81) * Math.PI / 180);
            
            // Calculate solar position
            const solarLon = -15 * (hours - 12);
            
            // Draw gray line as a thick band
            const grayLinePoints = [];
            for (let lat = -90; lat <= 90; lat += 5) {
                const solarAlt = Math.asin(
                    Math.sin(lat * Math.PI / 180) * Math.sin(declination * Math.PI / 180) +
                    Math.cos(lat * Math.PI / 180) * Math.cos(declination * Math.PI / 180) * 
                    Math.cos(solarLon * Math.PI / 180)
                ) * 180 / Math.PI;
                
                // Gray line is where solar altitude is near 0 (¬±6 degrees)
                if (Math.abs(solarAlt) < 6) {
                    grayLinePoints.push([lat, solarLon]);
                }
            }
            
            if (grayLinePoints.length > 0) {
                grayLineLayer = L.polyline(grayLinePoints, {
                    color: '#fbbf24',
                    weight: 40,
                    opacity: 0.3
                }).addTo(map);
            }
            
            document.getElementById('grayLineTime').textContent = 
                'Updated: ' + now.toUTCString().slice(17, 22) + ' UTC';
        }
        
        function updateGrayLine() {
            drawGrayLine();
        }
        
        function renderMap() {
            map = L.map('map', {
                center: [20, -30],
                zoom: 2,
                maxBounds: [[-90, -180], [90, 180]],
                zoomControl: true
            });
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬©OpenStreetMap, ¬©CartoDB',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Add home marker
            L.marker([44.374, -64.300], {
                icon: L.divIcon({
                    className: 'home-marker',
                    html: '<div style="background: #dc2626; color: white; padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; border: 2px solid #fca5a5;">VE1ATM</div>',
                    iconSize: [60, 20]
                })
            }).addTo(map);
            
            // Draw gray line
            drawGrayLine();
            
            // Add region markers
            const regions = {
                'EU': [50, 10], 'UK': [54, -2], 'JA': [36, 138],
                'VK': [-25, 135], 'ZL': [-41, 174], 'AF': [0, 20],
                'SA': [-15, -55], 'CA': [15, -90], 'AS': [30, 100], 'OC': [-10, 150]
            };
            
            const bands = propData.current_conditions.bands;
            
            for (const [regionCode, coords] of Object.entries(regions)) {
                let bestReliability = 0;
                let bestBand = null;
                let bestData = null;
                
                for (const [bandName, bandData] of Object.entries(bands)) {
                    const regionData = bandData.regions[regionCode];
                    if (regionData && regionData.reliability > bestReliability) {
                        bestReliability = regionData.reliability;
                        bestBand = bandName;
                        bestData = regionData;
                    }
                }
                
                if (bestData && bestReliability > 30) {
                    const color = bestData.quality === 'GOOD' ? '#4ade80' : 
                                bestData.quality === 'FAIR' ? '#fbbf24' : '#f87171';
                    
                    L.polyline([[44.374, -64.300], coords], {
                        color: color,
                        weight: 2,
                        opacity: 0.6,
                        dashArray: '8, 12'
                    }).addTo(map);
                    
                    L.circleMarker(coords, {
                        radius: 7,
                        fillColor: color,
                        color: color,
                        weight: 2,
                        opacity: 0.9,
                        fillOpacity: 0.7
                    }).addTo(map).bindPopup(`
                        <strong>${regionCode} - ${bestData.name}</strong><br>
                        Best: ${bestBand} (${bands[bestBand].frequency} MHz)<br>
                        Quality: ${bestData.quality}<br>
                        Reliability: ${bestData.reliability}%<br>
                        Signal: ${snrToSMeter(bestData.snr_db)}<br>
                        Distance: ${bestData.distance_km} km<br>
                        Bearing: ${bestData.bearing}¬∞
                    `);
                }
            }
        }
        
        function renderUpdateInfo() {
            const generated = new Date(propData.current_conditions.generated);
            document.getElementById('updateInfo').innerHTML = `
                <strong>Last Updated:</strong> ${generated.toLocaleString()} UTC<br>
                <em>72-hour forecast ‚Ä¢ Gray line updates every 5 minutes ‚Ä¢ Refresh after regenerating predictions</em>
            `;
        }

        // =================================================================
        // API Integration for On-Demand Prediction Generation
        // =================================================================

        let statusCheckInterval = null;

        function showModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('notificationModal').classList.add('show');
            document.getElementById('refreshBtn').disabled = true;
        }

        function hideModal() {
            document.getElementById('modalOverlay').classList.remove('show');
            document.getElementById('notificationModal').classList.remove('show');
            document.getElementById('refreshBtn').disabled = false;
        }

        function closeModal() {
            hideModal();
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        }

        function updateModalProgress(progress, message, isComplete = false) {
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('statusText').textContent = message;

            if (isComplete) {
                document.querySelector('.spinner').style.display = 'none';
                document.getElementById('closeBtn').style.display = 'inline-block';
                document.getElementById('modalHeader').textContent = 'Complete!';
            }
        }

        async function triggerRefresh() {
            try {
                showModal();
                updateModalProgress(0, 'Starting prediction generation...');

                // Call the generate API endpoint
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.status === 409) {
                    // Already running
                    updateModalProgress(50, 'Generation already in progress...', false);
                } else if (result.status === 'started') {
                    updateModalProgress(10, 'Prediction engine started...');
                    // Start polling for status
                    startStatusPolling();
                } else {
                    updateModalProgress(0, 'Error: ' + result.message, true);
                }

            } catch (error) {
                console.error('Error triggering refresh:', error);
                updateModalProgress(0, 'Error: ' + error.message, true);
            }
        }

        function startStatusPolling() {
            // Poll every 2 seconds
            statusCheckInterval = setInterval(checkGenerationStatus, 2000);
            checkGenerationStatus(); // Check immediately
        }

        async function checkGenerationStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                if (status.error) {
                    updateModalProgress(0, 'Error: ' + status.error, true);
                    if (statusCheckInterval) {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                    }
                    return;
                }

                updateModalProgress(status.progress, status.message);

                if (!status.running && status.progress >= 100) {
                    // Generation complete!
                    updateModalProgress(100, 'Predictions updated! Reloading dashboard...', true);

                    if (statusCheckInterval) {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                    }

                    // Reload data after a short delay
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                }

            } catch (error) {
                console.error('Error checking status:', error);
                updateModalProgress(0, 'Error checking status', true);
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                }
            }
        }

        // =================================================================
        // Station Configuration Functions
        // =================================================================

        const ANTENNA_TYPES = [
            { id: 'vertical', name: 'Vertical Monopole (1/4 wave)' },
            { id: 'dipole', name: 'Half-Wave Dipole' },
            { id: 'inverted_v', name: 'Inverted V' },
            { id: 'yagi', name: '3-Element Yagi' },
            { id: 'isotropic', name: 'Isotropic (Reference)' }
        ];

        let antennas = [];
        let antennaIdCounter = 0;

        function addAntenna() {
            const antennaId = antennaIdCounter++;
            antennas.push({
                id: antennaId,
                name: `Antenna ${antennaId + 1}`,
                type: 'vertical'
            });
            renderAntennas();
            updateBandAntennaSelects();
        }

        function removeAntenna(antennaId) {
            antennas = antennas.filter(a => a.id !== antennaId);
            renderAntennas();
            updateBandAntennaSelects();
        }

        function updateAntennaName(antennaId, newName) {
            const antenna = antennas.find(a => a.id === antennaId);
            if (antenna) {
                antenna.name = newName;
                updateBandAntennaSelects();
            }
        }

        function updateAntennaType(antennaId, newType) {
            const antenna = antennas.find(a => a.id === antennaId);
            if (antenna) {
                antenna.type = newType;
            }
        }

        function renderAntennas() {
            const antennaList = document.getElementById('antennaList');
            antennaList.innerHTML = '';

            antennas.forEach(antenna => {
                const antennaDiv = document.createElement('div');
                antennaDiv.style.cssText = 'background: #1a2332; padding: 1rem; border-radius: 4px; border: 1px solid #2a3f5f;';
                antennaDiv.innerHTML = `
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <input type="text" value="${antenna.name}"
                               onchange="updateAntennaName(${antenna.id}, this.value)"
                               style="flex: 1; padding: 0.4rem; background: #0a0e1a; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                        <button onclick="removeAntenna(${antenna.id})"
                                style="background: #8b2e2e; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
                    </div>
                    <select onchange="updateAntennaType(${antenna.id}, this.value)"
                            style="width: 100%; padding: 0.4rem; background: #0a0e1a; border: 1px solid #2a3f5f; color: #e0e0e0; border-radius: 4px;">
                        ${ANTENNA_TYPES.map(type =>
                            `<option value="${type.id}" ${antenna.type === type.id ? 'selected' : ''}>${type.name}</option>`
                        ).join('')}
                    </select>
                `;
                antennaList.appendChild(antennaDiv);
            });

            if (antennas.length === 0) {
                antennaList.innerHTML = '<div style="text-align: center; color: #8a9bb5; padding: 1rem;">No antennas configured. Click "Add Antenna" to get started.</div>';
            }
        }

        function updateBandAntennaSelects() {
            const selects = document.querySelectorAll('.band-antenna-select');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Not Configured</option>';
                antennas.forEach(antenna => {
                    const option = document.createElement('option');
                    option.value = antenna.id;
                    option.textContent = antenna.name;
                    if (currentValue == antenna.id) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }

        function saveStationConfig() {
            const config = {
                name: document.getElementById('stationName').value,
                callsign: document.getElementById('stationCallsign').value,
                grid: document.getElementById('stationGrid').value,
                lat: parseFloat(document.getElementById('stationLat').value),
                lon: parseFloat(document.getElementById('stationLon').value),
                power: parseInt(document.getElementById('stationPower').value)
            };

            fetch('/api/station-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                alert('Station configuration saved successfully!');
            })
            .catch(error => {
                console.error('Error saving station config:', error);
                alert('Error saving station configuration. See console for details.');
            });
        }

        function saveBandAssignments() {
            const assignments = {};
            const bands = ['160m', '80m', '40m', '30m', '20m', '17m', '15m', '12m', '10m'];
            bands.forEach(band => {
                const select = document.getElementById(`band-${band}`);
                if (select.value) {
                    assignments[band] = parseInt(select.value);
                }
            });

            const config = {
                antennas: antennas,
                band_assignments: assignments
            };

            fetch('/api/antenna-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                alert('Antenna configuration saved successfully!');
            })
            .catch(error => {
                console.error('Error saving antenna config:', error);
                alert('Error saving antenna configuration. See console for details.');
            });
        }

        function loadStationConfig() {
            // Load station info
            fetch('/api/station-config')
                .then(response => response.json())
                .then(config => {
                    if (config) {
                        document.getElementById('stationName').value = config.name || '';
                        document.getElementById('stationCallsign').value = config.callsign || '';
                        document.getElementById('stationGrid').value = config.grid || '';
                        document.getElementById('stationLat').value = config.lat || '';
                        document.getElementById('stationLon').value = config.lon || '';
                        document.getElementById('stationPower').value = config.power || '';
                    }
                })
                .catch(error => console.error('Error loading station config:', error));

            // Load antenna config
            fetch('/api/antenna-config')
                .then(response => response.json())
                .then(config => {
                    if (config && config.antennas) {
                        antennas = config.antennas;
                        antennaIdCounter = Math.max(...antennas.map(a => a.id), 0) + 1;
                        renderAntennas();
                        updateBandAntennaSelects();

                        if (config.band_assignments) {
                            Object.keys(config.band_assignments).forEach(band => {
                                const select = document.getElementById(`band-${band}`);
                                if (select) {
                                    select.value = config.band_assignments[band];
                                }
                            });
                        }
                    }
                })
                .catch(error => console.error('Error loading antenna config:', error));
        }

        // =================================================================
        // Initialize Dashboard
        // =================================================================

        loadPropagationData();
        loadStationConfig();
    </script>
</body>
</html>
