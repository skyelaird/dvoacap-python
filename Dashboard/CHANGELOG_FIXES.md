# Dashboard Fixes and Improvements - November 2025

## Summary

This document details the comprehensive fixes and improvements made to the VE1ATM HF Propagation Dashboard to address critical visualization and data interpretation issues.

## Issues Fixed

### 1. Grayline Visualization Bug (CRITICAL)

**Problem:**
- The grayline (solar terminator) was not displaying correctly on the band openings map
- Only showing an "amber blob" west of South America instead of a proper twilight band
- Algorithm was using a single longitude value for all latitudes

**Root Cause:**
The `drawGrayLine()` function in `dashboard.html` (line 2280) was calculating solar altitude at only one longitude (`solarLon`) for each latitude, resulting in disconnected points instead of a continuous terminator band.

**Fix Applied:**
- Completely rewrote the grayline calculation algorithm (dashboard.html:2280-2377)
- Now sweeps across all longitudes (-180° to +180°) and all latitudes (-90° to +90°)
- Calculates solar altitude using proper spherical astronomy equations
- Groups nearby points into latitude bands and creates polygon strips for smooth visualization
- Civil twilight zone (±6° solar altitude) is now properly rendered as a yellow band

**Technical Details:**
```javascript
// Old (incorrect):
const solarLon = -15 * (hours - 12);
for (let lat = -90; lat <= 90; lat += 5) {
    const solarAlt = ...; // Check at ONE longitude only
    if (Math.abs(solarAlt) < 6) {
        grayLinePoints.push([lat, solarLon]); // Same lon for all lats!
    }
}

// New (correct):
for (let lon = -180; lon <= 180; lon += 2) {
    for (let lat = -90; lat <= 90; lat += 2) {
        const hourAngle = (lon - solarLon) * Math.PI / 180;
        const solarAlt = Math.asin(Math.sin(latRad) * Math.sin(declinationRad) +
                                   Math.cos(latRad) * Math.cos(declinationRad) * Math.cos(hourAngle));
        if (Math.abs(solarAlt) < 6) {
            grayLinePoints.push([lat, lon]); // Correct lat/lon pair
        }
    }
}
```

---

### 2. Missing 80m and 160m Bands (CRITICAL)

**Problem:**
- 80m and 160m bands were being generated by the prediction engine but not displayed in the dashboard
- Only 40m-10m bands were shown (7 bands instead of 9)

**Root Cause:**
Multiple hardcoded band lists in the dashboard JavaScript only included 40m-10m bands.

**Fix Applied:**
- Updated all band lists to include 160m and 80m (5 locations in dashboard.html)
- Added band colors for new bands:
  - 160m: `#dc2626` (red)
  - 80m: `#ea580c` (orange)
- Updated CSS grid from `repeat(7, 1fr)` to `repeat(9, 1fr)` for band display
- Added frequency mappings in transform_data.py:
  - 160m: 1.900 MHz
  - 80m: 3.600 MHz

**Files Modified:**
- `dashboard.html` lines 169, 1512-1522, 1602, 1888
- `transform_data.py` lines 51-52

---

### 3. MUF Display Incorrect and Confusing (CRITICAL)

**Problem:**
- User reported: "How can I have reliability 100% and MUF usage 0%?"
- The MUF values were displayed backwards
- 20m to AF showed "100% reliability" and other charts contradicted this
- MUF "usage" terminology was confusing

**Root Cause:**
The `muf_day` value from VOACAP represents the **probability that MUF exceeds the operating frequency**:
- `muf_day = 1.0` (100%) = frequency **well below** MUF = **GOOD**
- `muf_day = 0.0` (0%) = frequency **at or above** MUF = **BAD**

But the dashboard was displaying this raw value as "MUF usage" which implies the opposite meaning, AND the scoring algorithm was backwards (penalizing good MUF values).

**Fix Applied:**

1. **Inverted Display Values** (dashboard.html:1842):
   ```javascript
   // Convert muf_day probability to MUF usage percentage
   const mufUsageData = regionData.muf_day.map(val => 100 - val);
   // Now: 0% usage = well below MUF (good)
   //      100% usage = at MUF limit (bad)
   ```

2. **Fixed Scoring Algorithm** (dashboard.html:1626):
   ```javascript
   // Old (incorrect):
   const mufScore = 100 - mufDay;  // Penalized good values!

   // New (correct):
   const mufScore = mufProb;  // Higher probability = better score
   ```

3. **Fixed Warning Threshold** (dashboard.html:1928-1929):
   ```javascript
   // Old: Warning when muf_day > 90 (WRONG - this is actually good!)
   // New: Warning when muf_usage > 90 (muf_day < 10) - frequency near MUF
   const mufUsage = 100 - bestMufProb;
   const warningIcon = mufUsage > 90 ? ' ⚠️' : '';
   ```

4. **Updated Help Text** (dashboard.html:1333-1352):
   - Clarified that "MUF Usage" shows how close to the MUF limit you are
   - Low usage (0-30%) = Very reliable, excellent conditions
   - High usage (>90%) = Near or above MUF, unreliable
   - Removed incorrect formula suggesting simple percentage calculation

5. **Added Code Comments** (generate_predictions.py:281-283):
   ```python
   # muf_day is probability that MUF exceeds frequency (1.0=well below MUF, 0.0=at/above MUF)
   # Dashboard inverts this to show "MUF usage percentage"
   'muf_day': round(pred.signal.muf_day * 100, 1),  # MUF probability (%) - inverted by dashboard for display
   ```

**Result:**
- MUF values now make logical sense: 0% usage = great, 100% usage = band closed
- Reliability and MUF usage values no longer contradict each other
- Users can now properly interpret propagation quality

---

### 4. Antenna Configuration Improvements

**Problem:**
- Antenna configuration system existed but lacked real-world examples
- No comprehensive antenna library for users to reference
- Difficult for users to configure multi-antenna setups

**Fix Applied:**

**Created `/Dashboard/antenna_config.json`** with:

1. **16 Real-World Antenna Definitions:**
   - DX Commander 7m Vertical (default)
   - G5RV Junior (40m-10m)
   - 40m Inverted V Dipole
   - End-Fed Half Wave (EFHW)
   - 3-Element Yagis (20m, 15m)
   - 80m Inverted L
   - Hex Beam (20m-10m)
   - Off-Center Fed Dipole (OCFD)
   - Buddipole Portable
   - Magnetic Loop
   - Butternut HF9V Vertical
   - 160m Longwire
   - Fan Dipole
   - Tri-Band Yagi
   - Attic Dipole

2. **Pre-configured Setup Examples:**
   - `dx_optimized`: Directional antennas on higher bands, wire/vertical on low bands
   - `wire_antennas`: All wire antenna setup for simple installation
   - `vertical_only`: Space-constrained installation
   - `portable_field`: Field day / portable operations

3. **Antenna Type Mapping:**
   - `isotropic`: Simple omnidirectional (e.g., magnetic loop)
   - `dipole`: Horizontal wire antennas (G5RV, EFHW, OCFD, fan dipole)
   - `vertical`: Ground-mounted verticals (DX Commander, Butternut, Inverted L)
   - `inverted-v`: Inverted V dipoles
   - `yagi`: Directional beam antennas (3-element, hex beam, tri-bander)

**Server API Already Exists:**
The server.py file already includes `/api/antenna-config` endpoints (lines 196-231):
- `GET /api/antenna-config`: Retrieves current antenna configuration
- `POST /api/antenna-config`: Saves new antenna configuration

**Usage:**
```bash
# View current configuration
curl http://localhost:8000/api/antenna-config

# Update configuration
curl -X POST http://localhost:8000/api/antenna-config \
     -H "Content-Type: application/json" \
     -d @antenna_config.json
```

---

## Files Modified

### Modified Files:
1. **Dashboard/dashboard.html**
   - Lines 169: Grid layout for 9 bands
   - Lines 1512-1522: Band list with 160m/80m + colors
   - Lines 1602: Best bands algorithm
   - Lines 1622-1627: Fixed MUF scoring
   - Lines 1839-1878: Fixed MUF chart display (inverted values)
   - Lines 1888: MRM indicator bands
   - Lines 1927-1941: Fixed MUF warning thresholds
   - Lines 2280-2377: Complete grayline algorithm rewrite
   - Lines 1281, 1293-1294, 1333-1383: Updated help text

2. **Dashboard/transform_data.py**
   - Lines 51-52: Added 160m and 80m frequency mappings

3. **Dashboard/generate_predictions.py**
   - Lines 281-283: Added clarifying comments about muf_day

### New Files:
4. **Dashboard/antenna_config.json** (NEW)
   - Complete antenna configuration library
   - Real-world examples and presets

5. **Dashboard/CHANGELOG_FIXES.md** (NEW - this file)
   - Comprehensive documentation of all fixes

---

## Testing Recommendations

### 1. Grayline Visualization
- [ ] Open dashboard and verify grayline appears as a yellow band across the map
- [ ] Use the time slider to move through 24 hours
- [ ] Verify grayline moves approximately 15° longitude per hour
- [ ] Check that grayline position matches sunrise/sunset zones

### 2. Band Display
- [ ] Verify all 9 bands appear in the dashboard (160m, 80m, 40m, 30m, 20m, 17m, 15m, 12m, 10m)
- [ ] Check that band colors are distinct and readable
- [ ] Verify propagation charts show data for 160m and 80m

### 3. MUF Values
- [ ] Generate fresh predictions
- [ ] Check that MUF usage values are inverted:
   - When reliability is high (>60%), MUF usage should be LOW (<50%)
   - When reliability is low (<30%), MUF usage should be HIGH (>70%)
- [ ] Verify warning icon (⚠️) appears when MUF usage >90%
- [ ] Confirm that high reliability + low MUF usage = good propagation

### 4. Antenna Configuration
- [ ] Verify `/api/antenna-config` endpoint returns the new configuration
- [ ] Test updating band assignments through the API
- [ ] Generate predictions with different antenna configurations
- [ ] Compare predictions between vertical and directional antennas

---

## Migration Notes

**For Existing Installations:**

1. **No Data Migration Required**
   - Existing `propagation_data.json` files will work with new code
   - The dashboard automatically inverts MUF values for display

2. **Antenna Configuration**
   - If no `antenna_config.json` exists, system uses default (DX Commander vertical)
   - Existing custom configurations will continue to work
   - New antenna library is available in `Dashboard/antenna_config.json`

3. **Regenerate Predictions**
   - Recommended to regenerate predictions to get 160m and 80m band data
   - Run: `python3 Dashboard/generate_predictions.py`
   - Or use: `curl -X POST http://localhost:8000/api/generate`

---

## Technical Implementation Details

### Grayline Algorithm

The new algorithm uses proper spherical astronomy to calculate the solar terminator:

1. **Solar Declination** (varies with day of year):
   ```
   δ = 23.45° × sin(360°/365 × (day - 81))
   ```

2. **Hour Angle** (varies with longitude and UTC time):
   ```
   H = (longitude - solar_longitude) × π/180
   solar_longitude = -15° × (UTC_hours - 12)
   ```

3. **Solar Altitude** (spherical trigonometry):
   ```
   sin(h) = sin(φ) × sin(δ) + cos(φ) × cos(δ) × cos(H)
   where φ = latitude, δ = declination, H = hour angle
   ```

4. **Twilight Zone**: Points where |h| < 6° (civil twilight)

### MUF Probability to Usage Conversion

```javascript
// VOACAP Engine Output:
muf_day = P(MUF > frequency)
  - Range: 0.0 to 1.0
  - 1.0 = frequency well below MUF (excellent)
  - 0.0 = frequency at/above MUF (poor)

// Dashboard Display:
muf_usage = 100 - (muf_day × 100)
  - Range: 0% to 100%
  - 0% = frequency well below MUF (excellent)
  - 100% = frequency at/above MUF (poor)
```

This makes the values intuitive: lower is better, higher is worse.

---

## Future Enhancements

While the current fixes address all critical issues, potential improvements include:

1. **Grayline Enhancement**
   - Add sunrise/sunset times for home station
   - Highlight grayline propagation opportunities
   - Show when both TX and RX are in grayline zone

2. **Antenna Visualization**
   - Show antenna gain patterns on the map
   - Display effective radiated power (ERP) by direction
   - Beam heading calculator for directional antennas

3. **Band-specific MUF Analysis**
   - Show MUF forecast for next 24-72 hours
   - Alert when bands open/close due to MUF changes
   - Historical MUF trends

4. **Low Band Support**
   - Add ground conductivity factors for 160m/80m
   - Enhanced noise floor modeling for low bands
   - NVIS (Near Vertical Incidence Skywave) mode for 80m/40m

---

## Credits

**Issues Reported By:** VE1ATM
**Fixes Implemented By:** Claude (Anthropic AI Assistant)
**Date:** November 17, 2025
**DVOACAP-Python Version:** Latest development branch

---

## Conclusion

All reported issues have been resolved:

✅ **Grayline visualization** - Now displays correctly as a continuous twilight band
✅ **80m and 160m bands** - Added to all display components
✅ **MUF values corrected** - Inverted for proper interpretation, scoring fixed
✅ **Antenna configuration** - Comprehensive library with 16 real-world examples

The dashboard now provides accurate, intuitive propagation predictions for all HF amateur radio bands from 160m to 10m, with proper grayline visualization and configurable antenna support.
